{% extends "base.html" %}

{% block title %}SIMS Uploader · Uploads{% endblock %}

{% block content %}
  <section class="panel">
    <header class="panel__header">
      <div>
        <h2>Recent Uploads</h2>
        <p class="muted">Monitor the most recent workbook uploads and their processing status.</p>
      </div>
      <div class="form-actions">
        <button class="primary-button" type="button" data-refresh-button>Refresh now</button>
      </div>
    </header>

    <div class="alert alert--info" data-queued-notice hidden>
      <div>
        <strong data-notice-title>Upload queued.</strong>
        <span data-notice-body>Processing will begin shortly.</span>
      </div>
      <button class="link-button" type="button" data-dismiss-notice aria-label="Dismiss notice">Dismiss</button>
    </div>

    <div
      class="table-wrapper"
      data-fetch-url="{{ request.url_for('list_recent_uploads') }}"
      data-load-error="{{ 'true' if load_error else 'false' }}"
      data-detail-template="{{ request.url_for('render_upload_detail', job_id='__JOB_ID__') }}"
    >
      <div class="table-state" data-loading-state hidden>Loading recent uploads…</div>
      <div class="table-state table-state--error" data-error-state {% if not load_error %}hidden{% endif %}>
        Unable to load uploads from the database. Trying again…
      </div>
      <div class="table-state table-state--empty" data-empty-state {% if jobs %}hidden{% endif %}>
        No uploads have been queued yet. Start by creating a new upload.
      </div>

      <table class="data-table" data-uploads-table {% if not jobs %}hidden{% endif %}>
        <thead>
          <tr>
            <th scope="col">Job ID</th>
            <th scope="col">Status</th>
            <th scope="col">Summary</th>
            <th scope="col">Result</th>
            <th scope="col">Created</th>
            <th scope="col">Updated</th>
            <th scope="col" class="align-right">Actions</th>
          </tr>
        </thead>
        <tbody data-uploads-table-body>
          {% for job in jobs %}
            <tr>
              <td><code>{{ job.job_id }}</code></td>
              <td class="status">{{ job.status }}</td>
              <td class="muted">{{ job.latest_message or '—' }}</td>
              <td class="muted">
                {% if job.processed_rows is not none or job.rejected_rows is not none %}
                  {{ (job.processed_rows or 0) | int }} processed{% if job.rejected_rows %}, {{ job.rejected_rows | int }} rejected{% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>{{ job.created_at }}</td>
              <td>{{ job.updated_at }}</td>
              <td class="align-right">
                <a class="link-button" href="{{ request.url_for('render_upload_detail', job_id=job.job_id) }}">View details</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
{% endblock %}

{% block scripts %}
  <script id="initial-jobs" type="application/json">{{ initial_jobs | tojson }}</script>
  <script>
    (function () {
      const table = document.querySelector('[data-uploads-table]');
      const tbody = document.querySelector('[data-uploads-table-body]');
      const emptyState = document.querySelector('[data-empty-state]');
      const loadingState = document.querySelector('[data-loading-state]');
      const errorState = document.querySelector('[data-error-state]');
      const fetchContainer = document.querySelector('[data-fetch-url]');
      const fetchUrl = fetchContainer ? fetchContainer.dataset.fetchUrl : null;
      const detailTemplate = fetchContainer?.dataset.detailTemplate || '';
      const loadError = fetchContainer ? fetchContainer.dataset.loadError === 'true' : false;
      const refreshButton = document.querySelector('[data-refresh-button]');
      const noticeBanner = document.querySelector('[data-queued-notice]');
      const noticeTitle = document.querySelector('[data-notice-title]');
      const noticeBody = document.querySelector('[data-notice-body]');
      const dismissNotice = document.querySelector('[data-dismiss-notice]');

      const initialJobsEl = document.getElementById('initial-jobs');
      let initialJobs = [];
      try {
        initialJobs = JSON.parse(initialJobsEl?.textContent || '[]') || [];
      } catch (err) {
        initialJobs = [];
      }

      if (errorState && loadError) {
        errorState.dataset.showSticky = 'true';
      }

      function formatDate(value) {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return value;
        }
        return date.toLocaleString();
      }

      function setVisibility(element, isVisible) {
        if (!element) return;
        element.hidden = !isVisible;
      }

      function renderRows(jobs) {
        if (!tbody) return;
        tbody.innerHTML = '';
        jobs.forEach((job) => {
          const row = document.createElement('tr');
          const detailUrl = detailTemplate
            ? detailTemplate.replace('__JOB_ID__', encodeURIComponent(job.job_id || ''))
            : '#';
          const processed = Number.isFinite(job.processed_rows) ? Number(job.processed_rows) : job.processed_rows;
          const rejected = Number.isFinite(job.rejected_rows) ? Number(job.rejected_rows) : job.rejected_rows;
          let resultSummary = '—';
          if (processed !== undefined && processed !== null) {
            resultSummary = `${processed} processed`;
            if (rejected !== undefined && rejected !== null) {
              resultSummary += `, ${rejected} rejected`;
            }
          } else if (rejected !== undefined && rejected !== null) {
            resultSummary = `0 processed, ${rejected} rejected`;
          }
          row.innerHTML = `
            <td><code>${job.job_id}</code></td>
            <td class="status">${job.status ?? '—'}</td>
            <td class="muted">${job.latest_message ?? '—'}</td>
            <td class="muted">${resultSummary}</td>
            <td>${formatDate(job.created_at)}</td>
            <td>${formatDate(job.updated_at)}</td>
            <td class="align-right">
              <a class="link-button" href="${detailUrl}">View details</a>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      function renderState(jobs) {
        setVisibility(table, jobs.length > 0);
        setVisibility(emptyState, jobs.length === 0);
        setVisibility(loadingState, false);
        if (errorState && errorState.dataset.showSticky === 'true') {
          setVisibility(errorState, true);
        } else {
          setVisibility(errorState, false);
        }
      }

      function populateFrom(jobs) {
        renderRows(jobs);
        renderState(jobs);
      }

      function showNoticeFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const noticeMessage = params.get('notice');
        if (!noticeMessage || !noticeBanner) return;

        const jobId = params.get('job_id');
        if (noticeTitle) {
          noticeTitle.textContent = 'Upload queued';
        }
        if (noticeBody) {
          noticeBody.textContent = jobId
            ? `${noticeMessage} Job ID: ${jobId}.`
            : `${noticeMessage}`;
        }

        setVisibility(noticeBanner, true);

        const clearedParams = new URLSearchParams(window.location.search);
        clearedParams.delete('notice');
        clearedParams.delete('job_id');
        const queryString = clearedParams.toString();

        dismissNotice?.addEventListener('click', () => {
          setVisibility(noticeBanner, false);
          window.history.replaceState(
            {},
            '',
            queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname
          );
        });
      }

      async function fetchUploads(options = {}) {
        const { showLoading = true } = options;
        if (!fetchUrl) return;
        if (showLoading) {
          setVisibility(loadingState, true);
        }
        setVisibility(errorState, false);
        try {
          const response = await fetch(fetchUrl);
          if (!response.ok) {
            throw new Error('Request failed');
          }
          const payload = await response.json();
          populateFrom(Array.isArray(payload) ? payload : []);
        } catch (err) {
          if (errorState) {
            errorState.dataset.showSticky = 'true';
            setVisibility(errorState, true);
          }
        } finally {
          if (showLoading) {
            setVisibility(loadingState, false);
          }
        }
      }

      populateFrom(initialJobs);
      showNoticeFromQuery();
      fetchUploads({ showLoading: !initialJobs.length });

      refreshButton?.addEventListener('click', () => {
        fetchUploads({ showLoading: true });
      });

      const POLL_INTERVAL_MS = 12000;
      setInterval(() => {
        fetchUploads({ showLoading: false });
      }, POLL_INTERVAL_MS);
    })();
  </script>
{% endblock %}
